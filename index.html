<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Craft2D â€” Multijoueur</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323:wght@400&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;}
  :root{
    --dirt:#8B6914;--grass:#4a9e3f;--stone:#888;--sand:#d4c06a;
    --wood:#8B6225;--water:#1a6bcc;--night:#0a0a1a;
    --ui-bg:rgba(0,0,0,0.85);--ui-border:#555;--ui-slot:#222;
    --gold:#f5c518;--health:#e83030;
  }
  body{background:#111;font-family:'VT323',monospace;color:#fff;overflow:hidden;height:100vh;width:100vw;}
  canvas{display:block;}

  /* â”€â”€ MENU â”€â”€ */
  #menu{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
    background:linear-gradient(180deg,#1a2a4a 0%,#0d1520 60%,#050a10 100%);z-index:100;}
  #menu h1{font-family:'Press Start 2P',monospace;font-size:clamp(18px,4vw,42px);
    color:#4aff4a;text-shadow:0 0 20px #4aff4a,0 0 40px #00aa00,3px 3px 0 #003300;
    margin-bottom:8px;letter-spacing:2px;}
  #menu .subtitle{font-size:22px;color:#aaa;margin-bottom:40px;}
  #menu .panel{background:rgba(0,0,0,0.7);border:2px solid #333;padding:32px;min-width:340px;
    display:flex;flex-direction:column;gap:14px;}
  #menu input{background:#1a1a1a;border:2px solid #444;color:#fff;padding:10px 14px;
    font-family:'VT323',monospace;font-size:22px;outline:none;width:100%;}
  #menu input:focus{border-color:#4aff4a;}
  #menu input::placeholder{color:#555;}
  .btn{background:#1a3a1a;border:2px solid #4aff4a;color:#4aff4a;padding:12px 20px;
    font-family:'Press Start 2P',monospace;font-size:11px;cursor:pointer;transition:all .15s;
    letter-spacing:1px;width:100%;}
  .btn:hover{background:#4aff4a;color:#000;}
  .btn.secondary{border-color:#888;color:#888;background:#111;}
  .btn.secondary:hover{background:#888;color:#000;}
  .divider{text-align:center;color:#444;font-size:18px;margin:4px 0;}
  #menu-error{color:#ff4444;font-size:18px;text-align:center;min-height:20px;}

  /* â”€â”€ HUD â”€â”€ */
  #hud{position:fixed;inset:0;pointer-events:none;z-index:10;}
  #coords{position:absolute;top:10px;left:10px;font-size:18px;color:#fff;
    text-shadow:1px 1px 2px #000;background:rgba(0,0,0,0.5);padding:4px 8px;}
  #room-info{position:absolute;top:10px;right:10px;font-size:18px;color:#fff;
    background:rgba(0,0,0,0.6);padding:4px 10px;text-align:right;}
  #day-indicator{position:absolute;top:10px;left:50%;transform:translateX(-50%);
    font-size:20px;color:#fff;background:rgba(0,0,0,0.5);padding:4px 12px;}
  
  /* Health bar */
  #health-bar{position:absolute;bottom:80px;left:50%;transform:translateX(-50%);
    display:flex;gap:3px;}
  .heart{width:18px;height:18px;display:inline-block;font-size:16px;}

  /* Hotbar */
  #hotbar{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
    display:flex;gap:3px;background:rgba(0,0,0,0.7);border:2px solid #555;padding:3px;}
  .hotbar-slot{width:50px;height:50px;background:#1a1a1a;border:2px solid #444;
    display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;
    pointer-events:all;}
  .hotbar-slot.active{border-color:#fff;}
  .hotbar-slot canvas{width:36px;height:36px;}
  .slot-count{position:absolute;bottom:2px;right:3px;font-size:16px;color:#fff;
    text-shadow:1px 1px 0 #000;}
  .slot-key{position:absolute;top:1px;left:3px;font-size:12px;color:#888;}

  /* â”€â”€ INVENTORY â”€â”€ */
  #inventory{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    background:#1a1a1a;border:2px solid #555;padding:20px;z-index:50;
    display:none;min-width:500px;}
  #inventory.open{display:block;}
  #inventory h2{font-family:'Press Start 2P',monospace;font-size:12px;margin-bottom:16px;color:#fff;}
  .inv-grid{display:grid;grid-template-columns:repeat(9,46px);gap:3px;margin-bottom:12px;}
  .inv-slot{width:46px;height:46px;background:#111;border:2px solid #333;
    display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;}
  .inv-slot:hover{border-color:#aaa;}
  .inv-slot.has-item{border-color:#555;}
  .inv-slot canvas{width:32px;height:32px;image-rendering:pixelated;}
  .inv-count{position:absolute;bottom:2px;right:3px;font-size:16px;color:#fff;text-shadow:1px 1px 0 #000;}
  .inv-section{font-size:16px;color:#aaa;margin:8px 0 4px;}
  .close-btn{position:absolute;top:8px;right:10px;background:none;border:none;color:#aaa;
    font-size:24px;cursor:pointer;}
  .close-btn:hover{color:#fff;}

  /* â”€â”€ CRAFTING â”€â”€ */
  #crafting{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    background:#1a1a1a;border:2px solid #555;padding:20px;z-index:51;display:none;min-width:420px;}
  #crafting.open{display:block;}
  #crafting h2{font-family:'Press Start 2P',monospace;font-size:11px;margin-bottom:14px;}
  .craft-layout{display:flex;align-items:center;gap:16px;}
  .craft-grid{display:grid;grid-template-columns:repeat(3,48px);gap:3px;}
  .craft-arrow{font-size:32px;color:#4aff4a;}
  .craft-result{width:60px;height:60px;background:#111;border:2px solid #4aff4a;
    display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;}
  .craft-result:hover{background:#1a3a1a;}
  #craft-tooltip{position:fixed;background:#111;border:1px solid #555;padding:6px 10px;
    font-size:16px;pointer-events:none;z-index:100;display:none;}
  #recipes-list{max-height:200px;overflow-y:auto;margin-top:12px;font-size:16px;}
  .recipe-item{padding:4px 6px;cursor:pointer;border-bottom:1px solid #222;}
  .recipe-item:hover{background:#222;}

  /* â”€â”€ CHAT â”€â”€ */
  #chat-container{position:fixed;bottom:80px;left:10px;z-index:20;width:340px;}
  #chat-messages{max-height:140px;overflow-y:auto;display:flex;flex-direction:column-reverse;gap:2px;}
  .chat-msg{font-size:18px;background:rgba(0,0,0,0.6);padding:2px 6px;word-break:break-all;}
  .chat-msg .chat-name{color:#4aff4a;}
  .chat-msg .chat-system{color:#ffaa00;}
  #chat-input-wrap{display:none;margin-top:4px;}
  #chat-input-wrap.open{display:flex;}
  #chat-input{background:rgba(0,0,0,0.8);border:1px solid #555;color:#fff;
    font-family:'VT323',monospace;font-size:20px;padding:4px 8px;flex:1;outline:none;}

  /* â”€â”€ DEATH SCREEN â”€â”€ */
  #death-screen{position:fixed;inset:0;background:rgba(100,0,0,0.7);display:none;
    flex-direction:column;align-items:center;justify-content:center;z-index:80;}
  #death-screen.show{display:flex;}
  #death-screen h2{font-family:'Press Start 2P',monospace;font-size:clamp(16px,3vw,32px);
    color:#ff4444;margin-bottom:8px;}
  #death-screen p{font-size:22px;color:#ffaaaa;margin-bottom:24px;}
  #respawn-coords{display:flex;gap:10px;align-items:center;margin-bottom:16px;font-size:20px;}
  #respawn-coords input{background:#222;border:1px solid #555;color:#fff;
    font-family:'VT323',monospace;font-size:20px;padding:4px 8px;width:90px;outline:none;}

  /* â”€â”€ CONTROLS HINT â”€â”€ */
  #controls{position:fixed;bottom:80px;right:10px;font-size:14px;color:#666;
    background:rgba(0,0,0,0.5);padding:6px 10px;line-height:1.8;}

  /* Tooltip */
  #block-tooltip{position:fixed;background:#111;border:1px solid #555;padding:4px 8px;
    font-size:16px;pointer-events:none;z-index:200;display:none;}
</style>
</head>
<body>

<!-- â”€â”€ MENU â”€â”€ -->
<div id="menu">
  <h1>â› CRAFT2D</h1>
  <p class="subtitle">Minecraft 2D Multijoueur</p>
  <div class="panel">
    <input id="player-name" placeholder="Ton pseudo..." maxlength="16">
    <button class="btn" onclick="createRoom()">ğŸŒ CrÃ©er un salon</button>
    <div class="divider">â€” ou rejoindre â€”</div>
    <input id="join-code" placeholder="Code du salon (ex: AB12CD)" maxlength="6" style="text-transform:uppercase">
    <button class="btn secondary" onclick="joinRoom()">ğŸ”— Rejoindre</button>
    <div id="menu-error"></div>
  </div>
</div>

<!-- â”€â”€ GAME â”€â”€ -->
<canvas id="game" style="display:none"></canvas>

<!-- â”€â”€ HUD â”€â”€ -->
<div id="hud" style="display:none">
  <div id="coords">X: 0 | Y: 0</div>
  <div id="room-info"></div>
  <div id="day-indicator">â˜€ï¸ Jour</div>
  <div id="health-bar"></div>
  <div id="hotbar"></div>
</div>

<!-- â”€â”€ CHAT â”€â”€ -->
<div id="chat-container" style="display:none">
  <div id="chat-messages"></div>
  <div id="chat-input-wrap">
    <input id="chat-input" placeholder="Message... (EntrÃ©e pour envoyer)" maxlength="200">
  </div>
</div>

<!-- â”€â”€ INVENTORY â”€â”€ -->
<div id="inventory">
  <button class="close-btn" onclick="closeInventory()">âœ•</button>
  <h2>ğŸ’ Inventaire</h2>
  <div class="inv-section">Inventaire (36 slots)</div>
  <div class="inv-grid" id="inv-grid"></div>
  <div class="inv-section">Ã‰quipement</div>
</div>

<!-- â”€â”€ CRAFTING â”€â”€ -->
<div id="crafting">
  <button class="close-btn" onclick="closeCrafting()">âœ•</button>
  <h2>ğŸ”¨ Ã‰tabli</h2>
  <div class="craft-layout">
    <div class="craft-grid" id="craft-grid"></div>
    <div class="craft-arrow">âœ</div>
    <div>
      <div class="craft-result" id="craft-result" onclick="craftItem()">
        <canvas id="craft-result-canvas" width="40" height="40"></canvas>
        <div class="inv-count" id="craft-result-count"></div>
      </div>
      <div style="font-size:16px;color:#aaa;margin-top:4px;text-align:center" id="craft-result-name"></div>
    </div>
  </div>
  <div class="inv-section">Recettes disponibles:</div>
  <div id="recipes-list"></div>
</div>

<!-- â”€â”€ DEATH SCREEN â”€â”€ -->
<div id="death-screen">
  <h2>â˜  Vous Ãªtes mort !</h2>
  <p>Vous avez perdu votre inventaire.</p>
  <div id="respawn-coords">
    <span>Spawn X:</span>
    <input id="spawn-x" type="number" value="0">
    <span>ou</span>
    <span id="bed-spawn-text" style="color:#4aff4a;display:none">ğŸ› Lit assignÃ©</span>
  </div>
  <button class="btn" onclick="respawn()">â†© RÃ©apparaÃ®tre</button>
</div>

<!-- â”€â”€ CONTROLS â”€â”€ -->
<div id="controls" style="display:none">
  WASD/â†â†’ : DÃ©placer | Espace : Sauter<br>
  Clic gauche : Casser | Clic droit : Poser<br>
  E : Inventaire | C : Craft | T : Chat<br>
  1-9 : Hotbar | Scroll : Changer slot
</div>

<!-- â”€â”€ BLOCK TOOLTIP â”€â”€ -->
<div id="block-tooltip"></div>
<div id="craft-tooltip"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS & BLOCK DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHUNK_SIZE = 16;
const TILE_SIZE = 32;
const WORLD_HEIGHT = 128;

const B = {
  AIR:0,GRASS:1,DIRT:2,STONE:3,SAND:4,GRAVEL:5,
  WOOD:6,LEAVES:7,WATER:8,LAVA:9,COAL_ORE:10,
  IRON_ORE:11,GOLD_ORE:12,DIAMOND_ORE:13,BEDROCK:14,
  PLANKS:15,COBBLESTONE:16,GLASS:17,BRICK:18,
  TORCH:19,CHEST:20,CRAFTING_TABLE:21,FURNACE:22,
  BED:23,DOOR:24,LADDER:25,TNT:26,OBSIDIAN:27,
  SNOW:28,ICE:29,CACTUS:30,CLAY:31,SANDSTONE:32,
  MOSSY_COBBLE:33,BOOKSHELF:34,WOOL:35,
};

const BLOCK_NAMES = {
  0:'Air',1:'Herbe',2:'Terre',3:'Pierre',4:'Sable',5:'Gravier',
  6:'Bois',7:'Feuilles',8:'Eau',9:'Lave',10:'Minerai de charbon',
  11:'Minerai de fer',12:'Minerai d\'or',13:'Minerai de diamant',14:'Roche de fond',
  15:'Planches',16:'Cobblestone',17:'Verre',18:'Brique',
  19:'Torche',20:'Coffre',21:'Ã‰tabli',22:'Four',
  23:'Lit',24:'Porte',25:'Ã‰chelle',26:'TNT',27:'Obsidienne',
  28:'Neige',29:'Glace',30:'Cactus',31:'Argile',32:'GrÃ¨s',
  33:'Cobble Moussu',34:'BibliothÃ¨que',35:'Laine',
};

// Drop tables: block -> [item dropped, count]
const DROPS = {
  [B.GRASS]:[B.DIRT,1],[B.DIRT]:[B.DIRT,1],[B.STONE]:[B.COBBLESTONE,1],
  [B.SAND]:[B.SAND,1],[B.GRAVEL]:[B.GRAVEL,1],[B.WOOD]:[B.WOOD,1],
  [B.LEAVES]:[B.LEAVES,1],[B.COAL_ORE]:[B.COAL_ORE,1],[B.IRON_ORE]:[B.IRON_ORE,1],
  [B.GOLD_ORE]:[B.GOLD_ORE,1],[B.DIAMOND_ORE]:[B.DIAMOND_ORE,1],
  [B.COBBLESTONE]:[B.COBBLESTONE,1],[B.PLANKS]:[B.PLANKS,1],
  [B.GLASS]:[B.GLASS,1],[B.BRICK]:[B.BRICK,1],[B.TNT]:[B.TNT,1],
  [B.OBSIDIAN]:[B.OBSIDIAN,1],[B.SANDSTONE]:[B.SANDSTONE,1],
  [B.CLAY]:[B.CLAY,1],[B.SNOW]:[B.SNOW,1],[B.ICE]:[B.ICE,1],
  [B.CACTUS]:[B.CACTUS,1],[B.TORCH]:[B.TORCH,1],[B.LADDER]:[B.LADDER,1],
  [B.CRAFTING_TABLE]:[B.CRAFTING_TABLE,1],[B.FURNACE]:[B.FURNACE,1],
  [B.BED]:[B.BED,1],[B.CHEST]:[B.CHEST,1],[B.BOOKSHELF]:[B.BOOKSHELF,1],
  [B.WOOL]:[B.WOOL,1],[B.MOSSY_COBBLE]:[B.MOSSY_COBBLE,1],
};

// Tool tiers: 0=hand,1=wood,2=stone,3=iron,4=gold,5=diamond
const BLOCK_HARDNESS = {
  [B.GRASS]:2,[B.DIRT]:2,[B.STONE]:15,[B.SAND]:3,[B.GRAVEL]:4,
  [B.WOOD]:10,[B.LEAVES]:2,[B.COAL_ORE]:15,[B.IRON_ORE]:20,
  [B.GOLD_ORE]:20,[B.DIAMOND_ORE]:25,[B.BEDROCK]:999,
  [B.COBBLESTONE]:15,[B.PLANKS]:8,[B.GLASS]:5,[B.BRICK]:12,
  [B.SANDSTONE]:8,[B.CLAY]:4,[B.SNOW]:2,[B.ICE]:4,
  [B.CACTUS]:2,[B.OBSIDIAN]:60,[B.CRAFTING_TABLE]:8,[B.FURNACE]:12,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CRAFTING RECIPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RECIPES = [
  // Basic
  { name:'Planches', grid:['6','','','','','','','',''], result:{item:B.PLANKS,count:4} },
  { name:'Ã‰tabli', grid:['15','15','','15','15','','','',''], result:{item:B.CRAFTING_TABLE,count:1} },
  { name:'BÃ¢tons', grid:['15','','','15','','','','',''], result:{item:99,count:4} }, // 99=sticks
  { name:'Coffre', grid:['15','15','15','15','0','15','15','15','15'], result:{item:B.CHEST,count:1} },
  // Tools - Pickaxe
  { name:'Pioche en bois', grid:['15','15','15','0','99','0','0','99','0'], result:{item:200,count:1} },
  { name:'Pioche en pierre', grid:['16','16','16','0','99','0','0','99','0'], result:{item:201,count:1} },
  { name:'Pioche en fer', grid:['11','11','11','0','99','0','0','99','0'], result:{item:202,count:1} },
  { name:'Pioche en or', grid:['12','12','12','0','99','0','0','99','0'], result:{item:203,count:1} },
  { name:'Pioche en diamant', grid:['13','13','13','0','99','0','0','99','0'], result:{item:204,count:1} },
  // Axe
  { name:'Hache en bois', grid:['15','15','0','15','99','0','0','99','0'], result:{item:210,count:1} },
  { name:'Hache en pierre', grid:['16','16','0','16','99','0','0','99','0'], result:{item:211,count:1} },
  { name:'Hache en fer', grid:['11','11','0','11','99','0','0','99','0'], result:{item:212,count:1} },
  // Sword
  { name:'Ã‰pÃ©e en bois', grid:['0','15','0','0','15','0','0','99','0'], result:{item:220,count:1} },
  { name:'Ã‰pÃ©e en pierre', grid:['0','16','0','0','16','0','0','99','0'], result:{item:221,count:1} },
  { name:'Ã‰pÃ©e en fer', grid:['0','11','0','0','11','0','0','99','0'], result:{item:222,count:1} },
  { name:'Ã‰pÃ©e en diamant', grid:['0','13','0','0','13','0','0','99','0'], result:{item:224,count:1} },
  // Blocks
  { name:'Verre', grid:['4','4','4','4','4','4','4','4','4'], result:{item:B.GLASS,count:8} }, // Sand->Glass (simplified)
  { name:'Torche (x4)', grid:['10','','','99','','','','',''], result:{item:B.TORCH,count:4} },
  { name:'Ã‰chelle', grid:['99','0','99','99','99','99','99','0','99'], result:{item:B.LADDER,count:3} },
  { name:'Lit', grid:['35','35','35','15','15','15','','',''], result:{item:B.BED,count:1} },
  { name:'TNT', grid:['26','4','26','4','26','4','26','4','26'], result:{item:B.TNT,count:1} },
  { name:'BibliothÃ¨que', grid:['15','15','15','34','34','34','15','15','15'], result:{item:B.BOOKSHELF,count:1} },
  { name:'Four', grid:['16','16','16','16','0','16','16','16','16'], result:{item:B.FURNACE,count:1} },
  { name:'Obsidienne', grid:['3','3','3','3','8','3','3','3','3'], result:{item:B.OBSIDIAN,count:4} },
];

// Items: 99=sticks, 200-209=pickaxes, 210-219=axes, 220-229=swords
const ITEM_NAMES = {
  99:'BÃ¢tons',200:'Pioche bois',201:'Pioche pierre',202:'Pioche fer',203:'Pioche or',204:'Pioche diamant',
  210:'Hache bois',211:'Hache pierre',212:'Hache fer',
  220:'Ã‰pÃ©e bois',221:'Ã‰pÃ©e pierre',222:'Ã‰pÃ©e fer',224:'Ã‰pÃ©e diamant',
};

// Tool mining speeds & damages
const TOOL_SPEED = {200:4,201:6,202:8,203:12,204:15,210:5,211:7,212:10};
const TOOL_DAMAGE = {220:4,221:5,222:6,224:8,99:1};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BLOCK RENDERER (Canvas pixel art)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawBlock(ctx, id, x, y, size, lightLevel=1) {
  const s = size;
  ctx.save();
  ctx.translate(x, y);
  const colors = getBlockColors(id);
  if (!colors) { ctx.restore(); return; }

  // Main fill
  ctx.fillStyle = applyLight(colors.main, lightLevel);
  ctx.fillRect(0, 0, s, s);

  // Highlights & details
  if (colors.top) {
    ctx.fillStyle = applyLight(colors.top, lightLevel);
    ctx.fillRect(0, 0, s, Math.ceil(s*0.2));
  }
  if (colors.detail) {
    ctx.fillStyle = applyLight(colors.detail, lightLevel);
    // Ore specks
    const spots = colors.spots || 3;
    for (let i=0; i<spots; i++) {
      const sx = (i*7+3) % (s-6); const sy = (i*11+5) % (s-6);
      ctx.fillRect(Math.floor(sx), Math.floor(sy), 4, 4);
    }
  }
  // Dark border
  ctx.fillStyle = applyLight(colors.shadow || colors.main, lightLevel * 0.6);
  ctx.fillRect(0, s-2, s, 2);
  ctx.fillRect(s-2, 0, 2, s);

  // Highlight
  ctx.fillStyle = 'rgba(255,255,255,0.15)';
  ctx.fillRect(0, 0, 2, s);
  ctx.fillRect(0, 0, s, 2);

  ctx.restore();
}

function getBlockColors(id) {
  switch(id) {
    case B.GRASS: return {main:'#3a8a30',top:'#4ab040',shadow:'#2a6020'};
    case B.DIRT: return {main:'#8B5E3C',top:'#9B6E4C',shadow:'#6B4020'};
    case B.STONE: return {main:'#7a7a7a',top:'#8a8a8a',shadow:'#555'};
    case B.SAND: return {main:'#D2B55B',top:'#E2C56B',shadow:'#B29040'};
    case B.GRAVEL: return {main:'#888',top:'#999',detail:'#666',spots:5};
    case B.WOOD: return {main:'#7B4F1E',top:'#9B6F3E',shadow:'#5B3010',detail:'#6B4010',spots:2};
    case B.LEAVES: return {main:'#2d7a1a',top:'#3d9a2a',shadow:'#1d5a0a'};
    case B.WATER: return {main:'#1a5aa0',top:'#2a7ad0',shadow:'#0a3a70'};
    case B.LAVA: return {main:'#cc3300',top:'#ff5500',shadow:'#aa1100'};
    case B.COAL_ORE: return {main:'#7a7a7a',detail:'#111',spots:4};
    case B.IRON_ORE: return {main:'#7a7a7a',detail:'#c0875a',spots:4};
    case B.GOLD_ORE: return {main:'#7a7a7a',detail:'#f5c518',spots:4};
    case B.DIAMOND_ORE: return {main:'#7a7a7a',detail:'#00e5ff',spots:4};
    case B.BEDROCK: return {main:'#222',top:'#333',shadow:'#111'};
    case B.PLANKS: return {main:'#b88040',top:'#c89050',shadow:'#886020'};
    case B.COBBLESTONE: return {main:'#666',top:'#777',shadow:'#444',detail:'#555',spots:6};
    case B.GLASS: return {main:'rgba(150,210,255,0.4)',top:'rgba(200,240,255,0.6)'};
    case B.BRICK: return {main:'#a04030',top:'#b05040',shadow:'#703020',detail:'#ccc',spots:3};
    case B.TORCH: return {main:'#c8a020',top:'#ffdd00',shadow:'#a07010'};
    case B.CHEST: return {main:'#8B5E3C',top:'#c8a060',shadow:'#5B3010',detail:'#f5c518',spots:1};
    case B.CRAFTING_TABLE: return {main:'#8B5E3C',top:'#2a7a2a',shadow:'#5B3010'};
    case B.FURNACE: return {main:'#666',top:'#888',shadow:'#444',detail:'#cc5500',spots:1};
    case B.BED: return {main:'#cc2222',top:'#dd4444',shadow:'#882222'};
    case B.DOOR: return {main:'#b88040',top:'#c89050',shadow:'#886020'};
    case B.LADDER: return {main:'#b88040',shadow:'#886020'};
    case B.TNT: return {main:'#cc2222',top:'#eeeeee',shadow:'#882222',detail:'#111',spots:2};
    case B.OBSIDIAN: return {main:'#1a0a2a',top:'#2a1a3a',shadow:'#0a0010'};
    case B.SNOW: return {main:'#e8f0ff',top:'#ffffff',shadow:'#b0c0dd'};
    case B.ICE: return {main:'#88bbff',top:'#aaddff',shadow:'#5588cc'};
    case B.CACTUS: return {main:'#2a8a20',top:'#3aaa30',shadow:'#1a5a10'};
    case B.CLAY: return {main:'#9090b0',top:'#a0a0c0',shadow:'#707090'};
    case B.SANDSTONE: return {main:'#c8a050',top:'#d8b060',shadow:'#a07030',detail:'#b08040',spots:2};
    case B.MOSSY_COBBLE: return {main:'#557755',top:'#668866',shadow:'#334433'};
    case B.BOOKSHELF: return {main:'#b88040',top:'#aa4422',shadow:'#886020',detail:'#4444aa',spots:3};
    case B.WOOL: return {main:'#cc6666',top:'#dd7777',shadow:'#aa3333'};
    default: return null;
  }
}

function applyLight(color, level) {
  if (level >= 1 || !color.startsWith('#')) return color;
  const r = parseInt(color.slice(1,3),16), g = parseInt(color.slice(3,5),16), b = parseInt(color.slice(5,7),16);
  return `rgb(${Math.floor(r*level)},${Math.floor(g*level)},${Math.floor(b*level)})`;
}

// Draw item icon (for inventory)
function drawItemIcon(canvas, itemId) {
  const ctx = canvas.getContext('2d');
  const s = canvas.width;
  ctx.clearRect(0,0,s,s);
  if (!itemId || itemId === B.AIR) return;
  if (itemId <= 35) { drawBlock(ctx, itemId, 0, 0, s); return; }
  // Tools
  ctx.strokeStyle = '#aaa'; ctx.lineWidth = 2;
  if (itemId >= 200 && itemId < 210) {
    // Pickaxe
    const colors = ['#b88040','#888','#c0875a','#f5c518','#00e5ff'];
    ctx.fillStyle = colors[(itemId-200)] || '#aaa';
    ctx.fillRect(s*0.1,s*0.1,s*0.6,s*0.15);
    ctx.fillStyle='#8B5E3C'; ctx.fillRect(s*0.4,s*0.2,s*0.2,s*0.7);
  } else if (itemId >= 210 && itemId < 220) {
    const colors = ['#b88040','#888','#c0875a'];
    ctx.fillStyle = colors[(itemId-210)] || '#aaa';
    ctx.fillRect(s*0.1,s*0.1,s*0.5,s*0.5);
    ctx.fillStyle='#8B5E3C'; ctx.fillRect(s*0.4,s*0.35,s*0.2,s*0.55);
  } else if (itemId >= 220 && itemId < 230) {
    const colors = ['#b88040','#888','#c0875a','#f5c518','#00e5ff'];
    ctx.fillStyle = colors[(itemId-220)] || '#aaa';
    ctx.fillRect(s*0.35,s*0.05,s*0.3,s*0.6);
    ctx.fillStyle='#8B5E3C'; ctx.fillRect(s*0.4,s*0.6,s*0.2,s*0.35);
  } else if (itemId === 99) {
    ctx.fillStyle = '#8B5E3C';
    ctx.fillRect(s*0.2,s*0.1,s*0.2,s*0.8);
    ctx.fillRect(s*0.6,s*0.1,s*0.2,s*0.8);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORLD / CHUNK CACHE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const chunks = new Map(); // cx -> { blocks:{key->id} }

function setChunk(cx, blocks) {
  chunks.set(cx, { blocks });
}

function getBlock(wx, wy) {
  if (wy < 0 || wy >= WORLD_HEIGHT) return B.AIR;
  const cx = Math.floor(wx / CHUNK_SIZE);
  const lx = ((wx % CHUNK_SIZE) + CHUNK_SIZE) % CHUNK_SIZE;
  const chunk = chunks.get(cx);
  if (!chunk) return B.AIR;
  return chunk.blocks[`${lx},${wy}`] || B.AIR;
}

function setBlockLocal(wx, wy, id) {
  const cx = Math.floor(wx / CHUNK_SIZE);
  const lx = ((wx % CHUNK_SIZE) + CHUNK_SIZE) % CHUNK_SIZE;
  let chunk = chunks.get(cx);
  if (!chunk) { chunk = {blocks:{}}; chunks.set(cx, chunk); }
  const key = `${lx},${wy}`;
  if (id === B.AIR) delete chunk.blocks[key];
  else chunk.blocks[key] = id;
}

function isPassable(b) {
  return b === B.AIR || b === B.WATER || b === B.TORCH || b === B.LADDER;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ws = null;
let playerId = null;
let roomCode = '';
let playerName = '';
let inGame = false;

const player = {
  x:0, y:0, vx:0, vy:0,
  hp:20, maxHp:20,
  onGround:false,
  width:0.8, height:1.8,
  dir:1,
  spawnX:0, spawnY:64,
  hasBed:false, bedX:0, bedY:0,
};

const GRAVITY = 0.35;
const JUMP_FORCE = -7;
const MOVE_SPEED = 4;
const PLAYER_COLOR = '#e08040';

// Inventory: 36 slots + hotbar (first 9)
const inventory = new Array(36).fill(null); // {item, count}
let activeSlot = 0;
let breakingBlock = null; // {x,y,progress,total}

// Other players
const otherPlayers = new Map();
// Mobs
const mobs = new Map();

// Camera
const cam = { x:0, y:0 };

// Day/night
let dayTime = 6000;

// Input
const keys = {};
let mouseX = 0, mouseY = 0;
let mouseDown = false;
let rightMouseDown = false;

// Chunks requested
const requestedChunks = new Set();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NETWORKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getWsUrl() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  // In dev: connect to localhost:3000; in prod: same host
  const host = location.hostname === 'localhost' ? 'localhost:3000' : location.host;
  return `${proto}://${host}`;
}

function connect(onOpen) {
  ws = new WebSocket(getWsUrl());
  ws.onopen = onOpen;
  ws.onmessage = (e) => handleMessage(JSON.parse(e.data));
  ws.onerror = () => showMenuError('Connexion impossible au serveur.');
  ws.onclose = () => { if(inGame) showMenuError('DÃ©connectÃ© du serveur.'); };
}

function send(obj) {
  if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(obj));
}

function createRoom() {
  playerName = document.getElementById('player-name').value.trim() || 'Player';
  connect(() => send({ type:'create_room', name: playerName }));
}

function joinRoom() {
  const code = document.getElementById('join-code').value.trim().toUpperCase();
  if (code.length < 4) { showMenuError('Code invalide.'); return; }
  playerName = document.getElementById('player-name').value.trim() || 'Player';
  connect(() => send({ type:'join_room', code, name: playerName }));
}

function handleMessage(msg) {
  switch(msg.type) {
    case 'joined':
      roomCode = msg.roomCode;
      playerId = msg.playerId;
      player.x = msg.x; player.y = msg.y;
      player.spawnX = msg.x; player.spawnY = msg.y;
      startGame();
      break;
    case 'chunk':
      setChunk(msg.cx, msg.blocks);
      break;
    case 'block_change':
      setBlockLocal(msg.x, msg.y, msg.block);
      break;
    case 'tick':
      dayTime = msg.dayTime;
      // Other players
      for (const pd of msg.players) {
        if (pd.id !== playerId) otherPlayers.set(pd.id, pd);
      }
      // Remove disconnected
      const ids = new Set(msg.players.map(p=>p.id));
      for (const [id] of otherPlayers) { if(!ids.has(id) && id!==playerId) otherPlayers.delete(id); }
      // Mobs
      mobs.clear();
      for (const m of msg.mobs) mobs.set(m.id, m);
      break;
    case 'damage':
      player.hp = msg.hp;
      updateHealthBar();
      if (player.hp <= 0) showDeathScreen();
      break;
    case 'respawned':
      player.x = msg.x; player.y = msg.y; player.hp = msg.hp;
      player.vx = 0; player.vy = 0;
      hideDeathScreen();
      updateHealthBar();
      break;
    case 'chat':
      addChatMsg(msg.name, msg.text);
      break;
    case 'chat_history':
      for (const m of msg.messages) addChatMsg(m.name, m.text);
      break;
    case 'player_join':
      addSystemMsg(`${msg.name} a rejoint le salon!`);
      break;
    case 'player_leave':
      otherPlayers.delete(msg.id);
      break;
    case 'mob_die':
      mobs.delete(msg.id);
      break;
    case 'error':
      showMenuError(msg.msg);
      break;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame() {
  inGame = true;
  document.getElementById('menu').style.display = 'none';
  document.getElementById('game').style.display = 'block';
  document.getElementById('hud').style.display = 'block';
  document.getElementById('chat-container').style.display = 'block';
  document.getElementById('controls').style.display = 'block';
  document.getElementById('room-info').textContent = `Salon: ${roomCode}`;

  resizeCanvas();
  buildHotbar();
  buildInventoryUI();
  buildCraftingUI();
  updateHealthBar();

  // Request initial chunks
  for (let cx = -4; cx <= 4; cx++) requestChunk(cx);

  gameLoop();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS & RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);

let lastTime = 0;
function gameLoop(ts=0) {
  const dt = Math.min((ts - lastTime) / 1000, 0.05);
  lastTime = ts;
  if (inGame) {
    update(dt);
    render();
  }
  requestAnimationFrame(gameLoop);
}

function worldToScreen(wx, wy) {
  return {
    x: (wx - cam.x) * TILE_SIZE + canvas.width/2,
    y: (wy - cam.y) * TILE_SIZE + canvas.height/2,
  };
}
function screenToWorld(sx, sy) {
  return {
    x: (sx - canvas.width/2) / TILE_SIZE + cam.x,
    y: (sy - canvas.height/2) / TILE_SIZE + cam.y,
  };
}

function getLightLevel() {
  // 0=night 1=day
  if (dayTime < 2000) return lerp(0.15, 1, dayTime/2000);
  if (dayTime < 10000) return 1;
  if (dayTime < 12000) return lerp(1, 0.15, (dayTime-10000)/2000);
  if (dayTime < 22000) return 0.15;
  return lerp(0.15, 1, (dayTime-22000)/2000);
}

function lerp(a,b,t){return a+t*(b-a);}

function render() {
  const W = canvas.width, H = canvas.height;
  const light = getLightLevel();

  // Sky
  const dayColor = ['#87CEEB','#6db5d8','#4a9fc8'];
  const nightColor = ['#0a0a1a','#0d0d25','#0a0a1a'];
  const skyR = Math.floor(lerp(parseInt(nightColor[0].slice(1,3),16), parseInt(dayColor[0].slice(1,3),16), light));
  const skyG = Math.floor(lerp(parseInt(nightColor[0].slice(3,5),16), parseInt(dayColor[0].slice(3,5),16), light));
  const skyB = Math.floor(lerp(parseInt(nightColor[0].slice(5,7),16), parseInt(dayColor[0].slice(5,7),16), light));
  ctx.fillStyle = `rgb(${skyR},${skyG},${skyB})`;
  ctx.fillRect(0,0,W,H);

  // Sun/Moon
  const sunAngle = (dayTime / 24000) * Math.PI * 2 - Math.PI/2;
  const sunR = Math.min(W,H) * 0.4;
  const sunX = W/2 + Math.cos(sunAngle) * sunR;
  const sunY = H/2 + Math.sin(sunAngle) * sunR;
  if (dayTime < 13000 || dayTime > 22000) {
    ctx.fillStyle = '#FFD700';
    ctx.beginPath(); ctx.arc(sunX,sunY,18,0,Math.PI*2); ctx.fill();
  } else {
    ctx.fillStyle = '#ddeeff';
    ctx.beginPath(); ctx.arc(sunX,sunY,14,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#aabbcc';
    ctx.beginPath(); ctx.arc(sunX+8,sunY-8,10,0,Math.PI*2); ctx.fill();
  }

  // Visible chunk range
  const tilesX = Math.ceil(W/TILE_SIZE/2)+2;
  const tilesY = Math.ceil(H/TILE_SIZE/2)+2;
  const startCX = Math.floor(cam.x/CHUNK_SIZE) - 1;
  const endCX = Math.floor(cam.x/CHUNK_SIZE) + Math.ceil(tilesX/CHUNK_SIZE) + 1;
  const startWX = Math.floor(cam.x) - tilesX;
  const endWX = Math.floor(cam.x) + tilesX;
  const startWY = Math.floor(cam.y) - tilesY;
  const endWY = Math.floor(cam.y) + tilesY;

  // Request missing chunks
  for (let cx = startCX; cx <= endCX; cx++) {
    if (!chunks.has(cx) && !requestedChunks.has(cx)) requestChunk(cx);
  }

  // Draw blocks
  for (let wy = Math.max(0,startWY); wy <= Math.min(WORLD_HEIGHT-1,endWY); wy++) {
    for (let wx = startWX; wx <= endWX; wx++) {
      const b = getBlock(wx, wy);
      if (b === B.AIR) continue;
      const {x,y} = worldToScreen(wx, wy);
      if (x < -TILE_SIZE || x > W+TILE_SIZE || y < -TILE_SIZE || y > H+TILE_SIZE) continue;
      drawBlock(ctx, b, x, y, TILE_SIZE, light);
    }
  }

  // Breaking progress
  if (breakingBlock) {
    const {x,y} = worldToScreen(breakingBlock.wx, breakingBlock.wy);
    const prog = breakingBlock.progress / breakingBlock.total;
    ctx.fillStyle = `rgba(0,0,0,${prog*0.7})`;
    ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
    ctx.fillStyle = '#fff';
    ctx.fillRect(x+2, y+TILE_SIZE-6, (TILE_SIZE-4)*prog, 4);
  }

  // Night overlay
  if (light < 1) {
    ctx.fillStyle = `rgba(0,0,20,${(1-light)*0.65})`;
    ctx.fillRect(0,0,W,H);
  }

  // Other players
  for (const [,pd] of otherPlayers) {
    const {x,y} = worldToScreen(pd.x, pd.y);
    drawCharacter(ctx, x, y, TILE_SIZE, pd.dir, '#4a90e2', pd.name);
  }

  // Mobs
  for (const [,mob] of mobs) {
    const {x,y} = worldToScreen(mob.x, mob.y);
    if (x < -64 || x > W+64) continue;
    drawMob(ctx, x, y, TILE_SIZE, mob);
  }

  // Player
  const {x:px,y:py} = worldToScreen(player.x, player.y);
  drawCharacter(ctx, px, py, TILE_SIZE, player.dir, '#e08040', playerName, true);

  // Cursor highlight
  const wPos = screenToWorld(mouseX, mouseY);
  const hx = Math.floor(wPos.x), hy = Math.floor(wPos.y);
  const {x:hsx,y:hsy} = worldToScreen(hx,hy);
  ctx.strokeStyle = 'rgba(255,255,255,0.6)'; ctx.lineWidth = 2;
  ctx.strokeRect(hsx+1, hsy+1, TILE_SIZE-2, TILE_SIZE-2);

  // Update HUD
  const iwx = Math.floor(player.x), iwy = Math.floor(player.y);
  document.getElementById('coords').textContent = `X: ${iwx} | Y: ${iwy}`;
  const dayPct = (dayTime/24000*100).toFixed(0);
  const isDay = dayTime < 13000 || dayTime > 22000;
  document.getElementById('day-indicator').textContent = isDay ? `â˜€ï¸ Jour` : `ğŸŒ™ Nuit`;
}

function drawCharacter(ctx, sx, sy, ts, dir, color, name, isLocal=false) {
  const w = ts*0.75, h = ts*1.8;
  const ox = (ts-w)/2;
  // Body
  ctx.fillStyle = color;
  ctx.fillRect(sx+ox, sy, w, h*0.6);
  // Head
  ctx.fillStyle = '#F5DEB3';
  ctx.fillRect(sx+ox+w*0.1, sy-ts*0.4, w*0.8, ts*0.4);
  // Eyes
  ctx.fillStyle = '#111';
  if (dir > 0) ctx.fillRect(sx+ox+w*0.55, sy-ts*0.25, 4, 4);
  else ctx.fillRect(sx+ox+w*0.2, sy-ts*0.25, 4, 4);
  // Legs
  ctx.fillStyle = '#2244aa';
  ctx.fillRect(sx+ox, sy+h*0.6, w*0.45, h*0.4);
  ctx.fillRect(sx+ox+w*0.55, sy+h*0.6, w*0.45, h*0.4);
  // Name tag
  if (name) {
    ctx.font = '14px VT323,monospace';
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    const nw = ctx.measureText(name).width;
    ctx.fillRect(sx+ox+w/2-nw/2-3, sy-ts*0.6-2, nw+6, 18);
    ctx.fillStyle = isLocal ? '#4aff4a' : '#fff';
    ctx.fillText(name, sx+ox+w/2-nw/2, sy-ts*0.6+12);
  }
}

function drawMob(ctx, sx, sy, ts, mob) {
  const colors = { zombie:'#3a8a3a', spider:'#333' };
  const c = colors[mob.type] || '#888';
  const w = ts*0.75, h = ts*1.6;
  const ox = (ts-w)/2;
  ctx.fillStyle = c;
  ctx.fillRect(sx+ox, sy, w, h);
  // Eyes (red)
  ctx.fillStyle = '#ff0000';
  const eyeX = mob.dir > 0 ? sx+ox+w*0.6 : sx+ox+w*0.15;
  ctx.fillRect(eyeX, sy+h*0.1, 5, 5);
  // HP bar
  const hpW = ts*0.9;
  ctx.fillStyle = '#300';
  ctx.fillRect(sx+ox-3, sy-10, hpW, 5);
  ctx.fillStyle = '#0f0';
  ctx.fillRect(sx+ox-3, sy-10, hpW*(mob.hp/20), 5);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHYSICS / UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let moveTimer = 0;

function update(dt) {
  if (document.getElementById('death-screen').classList.contains('show')) return;
  if (document.getElementById('chat-input-wrap').classList.contains('open')) return;

  const speed = MOVE_SPEED;
  let moving = false;

  if (keys['ArrowLeft']||keys['KeyA']) { player.vx = -speed; player.dir=-1; moving=true; }
  else if (keys['ArrowRight']||keys['KeyD']) { player.vx = speed; player.dir=1; moving=true; }
  else player.vx = 0;

  // Jump
  const belowBlock = getBlock(Math.floor(player.x), Math.floor(player.y+player.height));
  player.onGround = !isPassable(belowBlock);
  if ((keys['Space']||keys['ArrowUp']||keys['KeyW']) && player.onGround) {
    player.vy = JUMP_FORCE;
  }

  // On ladder
  const midBlock = getBlock(Math.floor(player.x), Math.floor(player.y+0.9));
  if (midBlock === B.LADDER) {
    player.vy = (keys['ArrowUp']||keys['KeyW']) ? -3 : (keys['ArrowDown']||keys['KeyS']) ? 3 : 0;
  } else {
    player.vy += GRAVITY;
    player.vy = Math.min(player.vy, 12);
  }

  // Move X
  const nx = player.x + player.vx * dt;
  const colX1 = !isPassable(getBlock(Math.floor(nx), Math.floor(player.y)));
  const colX2 = !isPassable(getBlock(Math.floor(nx), Math.floor(player.y+player.height-0.1)));
  if (!colX1 && !colX2) player.x = nx;
  else player.vx = 0;

  // Move Y
  const ny = player.y + player.vy * dt;
  const colY1 = !isPassable(getBlock(Math.floor(player.x), Math.floor(ny)));
  const colY2 = !isPassable(getBlock(Math.floor(player.x+player.width-0.1), Math.floor(ny)));
  if (!colY1 && !colY2) {
    player.y = ny;
  } else {
    if (player.vy > 0) player.y = Math.floor(player.y+player.height)/1 - player.height;
    player.vy = 0;
  }

  // Block breaking
  if (mouseDown && !document.getElementById('inventory').classList.contains('open') && !document.getElementById('crafting').classList.contains('open')) {
    const wPos = screenToWorld(mouseX, mouseY);
    const bx = Math.floor(wPos.x), by = Math.floor(wPos.y);
    const dist = Math.hypot(bx - player.x, by - player.y);
    if (dist < 6) {
      const b = getBlock(bx, by);
      if (b !== B.AIR) {
        const hardness = BLOCK_HARDNESS[b] || 5;
        const toolItem = inventory[activeSlot]?.item;
        const speed = TOOL_SPEED[toolItem] || 1;
        const ticksNeeded = Math.ceil(hardness / speed);
        if (!breakingBlock || breakingBlock.wx !== bx || breakingBlock.wy !== by) {
          breakingBlock = { wx:bx, wy:by, progress:0, total:ticksNeeded };
        }
        breakingBlock.progress++;
        if (breakingBlock.progress >= breakingBlock.total) {
          // Break it
          send({ type:'break_block', x:bx, y:by });
          setBlockLocal(bx, by, B.AIR);
          // Add drop to inventory
          const drop = DROPS[b];
          if (drop) addToInventory(drop[0], drop[1]);
          breakingBlock = null;
        }
      } else { breakingBlock = null; }
    } else { breakingBlock = null; }
  } else { breakingBlock = null; }

  // Camera follow
  cam.x = player.x;
  cam.y = player.y - 1;

  // Send position
  moveTimer += dt;
  if (moveTimer > 0.05) {
    send({ type:'move', x:player.x, y:player.y, dir:player.dir });
    moveTimer = 0;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INVENTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addToInventory(item, count) {
  // Stack first
  for (let i=0; i<inventory.length; i++) {
    if (inventory[i]?.item === item && inventory[i].count < 64) {
      inventory[i].count += count;
      refreshHotbar();
      refreshInventoryUI();
      return true;
    }
  }
  // Empty slot
  for (let i=0; i<inventory.length; i++) {
    if (!inventory[i]) {
      inventory[i] = {item, count};
      refreshHotbar();
      refreshInventoryUI();
      return true;
    }
  }
  return false;
}

function removeFromInventory(item, count) {
  for (let i=0; i<inventory.length; i++) {
    if (inventory[i]?.item === item) {
      inventory[i].count -= count;
      if (inventory[i].count <= 0) inventory[i] = null;
      refreshHotbar();
      refreshInventoryUI();
      return true;
    }
  }
  return false;
}

function hasItem(item, count=1) {
  let total = 0;
  for (const s of inventory) if (s?.item === item) total += s.count;
  return total >= count;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI: HOTBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildHotbar() {
  const hb = document.getElementById('hotbar');
  hb.innerHTML = '';
  for (let i=0; i<9; i++) {
    const slot = document.createElement('div');
    slot.className = 'hotbar-slot' + (i===activeSlot?' active':'');
    slot.innerHTML = `<span class="slot-key">${i+1}</span><canvas width="36" height="36" style="image-rendering:pixelated"></canvas><span class="slot-count"></span>`;
    slot.onclick = () => { activeSlot=i; refreshHotbar(); };
    hb.appendChild(slot);
  }
  refreshHotbar();
}

function refreshHotbar() {
  const slots = document.querySelectorAll('.hotbar-slot');
  slots.forEach((slot,i) => {
    slot.className = 'hotbar-slot'+(i===activeSlot?' active':'');
    const cv = slot.querySelector('canvas');
    const cnt = slot.querySelector('.slot-count');
    const inv = inventory[i];
    if (inv) { drawItemIcon(cv, inv.item); cnt.textContent = inv.count>1?inv.count:''; }
    else { const c=cv.getContext('2d'); c.clearRect(0,0,36,36); cnt.textContent=''; }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI: INVENTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildInventoryUI() {
  const grid = document.getElementById('inv-grid');
  grid.innerHTML = '';
  for (let i=0; i<36; i++) {
    const slot = document.createElement('div');
    slot.className = 'inv-slot';
    slot.id = `inv-slot-${i}`;
    slot.innerHTML = `<canvas width="32" height="32" style="image-rendering:pixelated"></canvas><span class="inv-count"></span>`;
    slot.addEventListener('mouseenter', () => {
      if(inventory[i]) showBlockTooltip(getItemName(inventory[i].item));
    });
    slot.addEventListener('mouseleave', hideBlockTooltip);
    grid.appendChild(slot);
  }
  refreshInventoryUI();
}

function refreshInventoryUI() {
  for (let i=0; i<36; i++) {
    const slot = document.getElementById(`inv-slot-${i}`);
    if (!slot) continue;
    const cv = slot.querySelector('canvas');
    const cnt = slot.querySelector('.inv-count');
    const inv = inventory[i];
    if (inv) { drawItemIcon(cv, inv.item); cnt.textContent = inv.count>1?inv.count:''; slot.classList.add('has-item'); }
    else { const c=cv.getContext('2d'); c.clearRect(0,0,32,32); cnt.textContent=''; slot.classList.remove('has-item'); }
  }
}

function openInventory() {
  document.getElementById('inventory').classList.add('open');
  refreshInventoryUI();
}
function closeInventory() { document.getElementById('inventory').classList.remove('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI: CRAFTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const craftGrid = new Array(9).fill(null);

function buildCraftingUI() {
  const grid = document.getElementById('craft-grid');
  grid.innerHTML = '';
  for (let i=0; i<9; i++) {
    const slot = document.createElement('div');
    slot.className = 'inv-slot';
    slot.id = `craft-slot-${i}`;
    slot.style.width='48px'; slot.style.height='48px';
    slot.innerHTML = `<canvas width="36" height="36" style="image-rendering:pixelated"></canvas><span class="inv-count"></span>`;
    slot.addEventListener('click', () => {
      // Place/remove item from active hotbar slot
      if (inventory[activeSlot]) {
        const item = inventory[activeSlot].item;
        craftGrid[i] = String(item);
        refreshCraftGrid();
        checkCraftResult();
      }
    });
    slot.addEventListener('contextmenu', e => { e.preventDefault(); craftGrid[i]=null; refreshCraftGrid(); checkCraftResult(); });
    grid.appendChild(slot);
  }

  // Recipe list
  const rl = document.getElementById('recipes-list');
  rl.innerHTML = '';
  for (const r of RECIPES) {
    const div = document.createElement('div');
    div.className = 'recipe-item';
    div.textContent = `${r.name} (${getItemName(r.result.item)} x${r.result.count})`;
    div.onclick = () => loadRecipe(r);
    rl.appendChild(div);
  }
}

function loadRecipe(recipe) {
  for (let i=0; i<9; i++) craftGrid[i] = recipe.grid[i]==='0'?null:recipe.grid[i];
  refreshCraftGrid();
  checkCraftResult();
}

function refreshCraftGrid() {
  for (let i=0; i<9; i++) {
    const slot = document.getElementById(`craft-slot-${i}`);
    if (!slot) continue;
    const cv = slot.querySelector('canvas');
    const cnt = slot.querySelector('.inv-count');
    const item = craftGrid[i] ? parseInt(craftGrid[i]) : null;
    if (item) { drawItemIcon(cv, item); cnt.textContent=''; }
    else { const c=cv.getContext('2d'); c.clearRect(0,0,36,36); cnt.textContent=''; }
  }
}

function checkCraftResult() {
  const gridStr = craftGrid.map(c=>c||'0');
  for (const r of RECIPES) {
    const rg = r.grid.map(c=>c||'0');
    if (gridStr.join(',') === rg.join(',')) {
      // Check if player has ingredients
      const needed = {};
      for (const c of rg) { if(c!=='0') needed[c]=(needed[c]||0)+1; }
      let canCraft = true;
      for (const [item,cnt] of Object.entries(needed)) {
        if (!hasItem(parseInt(item), cnt)) { canCraft=false; break; }
      }
      // Show result
      const rc = document.getElementById('craft-result-canvas');
      drawItemIcon(rc, r.result.item);
      document.getElementById('craft-result-count').textContent = r.result.count>1?r.result.count:'';
      document.getElementById('craft-result-name').textContent = canCraft ? r.name : 'âŒ '+r.name;
      document.getElementById('craft-result').style.opacity = canCraft ? '1' : '0.5';
      document.getElementById('craft-result').dataset.recipe = JSON.stringify(r);
      document.getElementById('craft-result').dataset.canCraft = canCraft ? '1' : '0';
      return;
    }
  }
  // No match
  const rc = document.getElementById('craft-result-canvas');
  const rc2 = rc.getContext('2d'); rc2.clearRect(0,0,40,40);
  document.getElementById('craft-result-count').textContent='';
  document.getElementById('craft-result-name').textContent='';
  document.getElementById('craft-result').dataset.recipe='';
}

function craftItem() {
  const el = document.getElementById('craft-result');
  if (el.dataset.canCraft !== '1' || !el.dataset.recipe) return;
  const r = JSON.parse(el.dataset.recipe);
  // Consume
  const needed = {};
  for (const c of r.grid) { if(c&&c!=='0') needed[c]=(needed[c]||0)+1; }
  for (const [item,cnt] of Object.entries(needed)) {
    removeFromInventory(parseInt(item), cnt);
  }
  addToInventory(r.result.item, r.result.count);
  for (let i=0; i<9; i++) craftGrid[i]=null;
  refreshCraftGrid();
  checkCraftResult();
}

function openCrafting() {
  document.getElementById('crafting').classList.add('open');
  buildCraftingUI();
}
function closeCrafting() { document.getElementById('crafting').classList.remove('open'); }

function getItemName(id) {
  return ITEM_NAMES[id] || BLOCK_NAMES[id] || `Item ${id}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI: HEALTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHealthBar() {
  const bar = document.getElementById('health-bar');
  bar.innerHTML = '';
  for (let i=0; i<10; i++) {
    const heart = document.createElement('span');
    heart.className = 'heart';
    const filled = player.hp >= (i+1)*2;
    const half = !filled && player.hp >= i*2+1;
    heart.textContent = filled ? 'â¤ï¸' : half ? 'ğŸ’”' : 'ğŸ–¤';
    bar.appendChild(heart);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI: CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addChatMsg(name, text) {
  const div = document.createElement('div');
  div.className = 'chat-msg';
  div.innerHTML = `<span class="chat-name">${escHtml(name)}</span>: ${escHtml(text)}`;
  const msgs = document.getElementById('chat-messages');
  msgs.prepend(div);
  setTimeout(() => { if(div.parentNode) div.remove(); }, 15000);
}

function addSystemMsg(text) {
  const div = document.createElement('div');
  div.className = 'chat-msg';
  div.innerHTML = `<span class="chat-system">â˜… ${escHtml(text)}</span>`;
  document.getElementById('chat-messages').prepend(div);
  setTimeout(() => { if(div.parentNode) div.remove(); }, 15000);
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function openChat() {
  const wrap = document.getElementById('chat-input-wrap');
  wrap.classList.add('open');
  document.getElementById('chat-input').focus();
}

function closeChat() {
  const wrap = document.getElementById('chat-input-wrap');
  wrap.classList.remove('open');
  document.getElementById('chat-input').blur();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI: DEATH / RESPAWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showDeathScreen() {
  const ds = document.getElementById('death-screen');
  ds.classList.add('show');
  // Clear inventory
  for (let i=0; i<inventory.length; i++) inventory[i]=null;
  refreshHotbar(); refreshInventoryUI();
  // Show bed option
  document.getElementById('bed-spawn-text').style.display = player.hasBed ? 'inline' : 'none';
  document.getElementById('spawn-x').value = player.spawnX;
}

function hideDeathScreen() {
  document.getElementById('death-screen').classList.remove('show');
}

function respawn() {
  const sx = parseInt(document.getElementById('spawn-x').value) || 0;
  send({ type:'respawn', spawnX: sx });
  hideDeathScreen();
  player.hp = 20; updateHealthBar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHUNKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function requestChunk(cx) {
  if (requestedChunks.has(cx)) return;
  requestedChunks.add(cx);
  send({ type:'request_chunk', cx });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOOLTIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showBlockTooltip(text) {
  const tt = document.getElementById('block-tooltip');
  tt.textContent = text; tt.style.display = 'block';
}
function hideBlockTooltip() { document.getElementById('block-tooltip').style.display='none'; }

document.addEventListener('mousemove', e => {
  mouseX=e.clientX; mouseY=e.clientY;
  const tt = document.getElementById('block-tooltip');
  tt.style.left=(e.clientX+14)+'px'; tt.style.top=(e.clientY+10)+'px';

  // Show block name under cursor
  if (inGame && !document.getElementById('inventory').classList.contains('open')) {
    const wPos = screenToWorld(e.clientX, e.clientY);
    const b = getBlock(Math.floor(wPos.x), Math.floor(wPos.y));
    if (b !== B.AIR) showBlockTooltip(BLOCK_NAMES[b]||`Block ${b}`);
    else hideBlockTooltip();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e => {
  keys[e.code] = true;
  if (!inGame) return;

  const chatOpen = document.getElementById('chat-input-wrap').classList.contains('open');

  if (e.code === 'KeyT' && !chatOpen) { e.preventDefault(); openChat(); return; }
  if (e.code === 'Escape') {
    closeInventory(); closeCrafting(); closeChat();
    return;
  }
  if (chatOpen) {
    if (e.code === 'Enter') {
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if (text) { send({ type:'chat', text }); input.value=''; }
      closeChat();
    }
    return;
  }

  if (e.code === 'KeyE') { document.getElementById('inventory').classList.toggle('open'); refreshInventoryUI(); }
  if (e.code === 'KeyC') { document.getElementById('crafting').classList.toggle('open'); if(document.getElementById('crafting').classList.contains('open')) buildCraftingUI(); }

  // Hotbar 1-9
  if (e.code.startsWith('Digit')) {
    const n = parseInt(e.code.slice(5)) - 1;
    if (n >= 0 && n <= 8) { activeSlot=n; refreshHotbar(); }
  }
});

document.addEventListener('keyup', e => { keys[e.code] = false; });

document.addEventListener('wheel', e => {
  if (!inGame) return;
  activeSlot = (activeSlot + (e.deltaY > 0 ? 1 : -1) + 9) % 9;
  refreshHotbar();
});

canvas.addEventListener('mousedown', e => {
  if (!inGame) return;
  if (e.button === 0) mouseDown = true;
  if (e.button === 2) {
    // Place block
    const wPos = screenToWorld(e.clientX, e.clientY);
    const bx = Math.floor(wPos.x), by = Math.floor(wPos.y);
    const dist = Math.hypot(bx - player.x, by - player.y);
    if (dist < 6 && getBlock(bx,by) === B.AIR) {
      const activeItem = inventory[activeSlot];
      if (activeItem && activeItem.item <= 35 && activeItem.item !== B.AIR) {
        // Don't place inside player
        const px = Math.floor(player.x), py = Math.floor(player.y);
        if (!((bx===px||bx===px) && (by===py||by===py+1))) {
          send({ type:'place_block', x:bx, y:by, block:activeItem.item });
          setBlockLocal(bx, by, activeItem.item);
          if (activeItem.item === B.BED) {
            player.hasBed=true; player.bedX=bx; player.bedY=by;
            addSystemMsg('Lit assignÃ© comme point de respawn!');
          }
          removeFromInventory(activeItem.item, 1);
        }
      }
    }
    // Attack mob
    for (const [,mob] of mobs) {
      const mDist = Math.hypot(mob.x - player.x, mob.y - player.y);
      if (mDist < 3) {
        const dmg = TOOL_DAMAGE[inventory[activeSlot]?.item] || 2;
        send({ type:'attack_mob', mobId:mob.id, damage:dmg });
        break;
      }
    }
  }
});

canvas.addEventListener('mouseup', e => { if(e.button===0) mouseDown=false; });
canvas.addEventListener('contextmenu', e => e.preventDefault());

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MENU UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showMenuError(msg) {
  document.getElementById('menu-error').textContent = msg;
  document.getElementById('menu').style.display = 'flex';
  document.getElementById('game').style.display = 'none';
  document.getElementById('hud').style.display = 'none';
}

// Start with some items for testing
function giveStarterItems() {
  addToInventory(B.CRAFTING_TABLE, 1);
  addToInventory(B.TORCH, 8);
  addToInventory(B.PLANKS, 16);
  addToInventory(B.DIRT, 32);
}

// Give starter items when game starts
const _startGame = startGame;
startGame = function() {
  _startGame();
  giveStarterItems();
};
</script>
</body>
</html>
